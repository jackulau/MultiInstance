name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build Windows
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-release-

      - name: Install ImageMagick
        run: choco install imagemagick -y

      - name: Generate Windows icon
        shell: pwsh
        run: |
          # Find ImageMagick installation directory dynamically
          $magickPath = Get-ChildItem "C:\Program Files\ImageMagick*" -Directory | Select-Object -First 1
          if ($magickPath) {
            $env:PATH = "$($magickPath.FullName);$env:PATH"
            Write-Host "Found ImageMagick at: $($magickPath.FullName)"
          }

          # Ensure resources/windows directory exists
          New-Item -ItemType Directory -Force -Path "resources/windows" | Out-Null

          if (Test-Path "assets/MultiInstance_Logo.svg") {
            magick convert "assets/MultiInstance_Logo.svg" `
              -background none `
              "(" -clone 0 -resize 16x16 ")" `
              "(" -clone 0 -resize 32x32 ")" `
              "(" -clone 0 -resize 48x48 ")" `
              "(" -clone 0 -resize 64x64 ")" `
              "(" -clone 0 -resize 128x128 ")" `
              "(" -clone 0 -resize 256x256 ")" `
              -delete 0 `
              "resources/windows/app.ico"
            Write-Host "Icon generated successfully"
          } else {
            Write-Host "Warning: SVG not found, creating placeholder icon"
            magick convert -size 256x256 xc:navy -fill white -gravity center -pointsize 72 -annotate 0 "MI" "resources/windows/app.ico"
          }

      - name: Build
        run: cargo build --release --target x86_64-pc-windows-msvc

      - name: Get version
        id: get_version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $distDir = "dist"
          New-Item -ItemType Directory -Force -Path $distDir
          Copy-Item "target/x86_64-pc-windows-msvc/release/multiinstance.exe" "$distDir/MultiInstance.exe"
          if (Test-Path "README.md") { Copy-Item "README.md" "$distDir/" }
          if (Test-Path "LICENSE") { Copy-Item "LICENSE" "$distDir/" }
          Compress-Archive -Path "$distDir/*" -DestinationPath "MultiInstance-$version-windows-x64.zip"

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Create installer
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $issContent = Get-Content "scripts/installer.iss" -Raw
          $issContent = $issContent -replace '#define MyAppVersion "1.0.0"', "#define MyAppVersion `"$version`""
          $issContent | Set-Content "scripts/installer.iss"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "scripts/installer.iss"

          # Find and rename the installer
          $installerPath = Get-ChildItem -Path "target/x86_64-pc-windows-msvc/release" -Filter "MultiInstance-*-setup.exe" | Select-Object -First 1
          if ($installerPath) {
            Move-Item $installerPath.FullName "MultiInstance-$version-windows-x64-setup.exe"
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            MultiInstance-*-windows-x64.zip
            MultiInstance-*-windows-x64-setup.exe

  # Build macOS (Intel)
  build-macos-intel:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-intel-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-intel-cargo-release-

      - name: Install ImageMagick
        run: brew install imagemagick

      - name: Generate macOS icon
        run: |
          # Ensure resources/macos directory exists
          mkdir -p "resources/macos"

          if [ -f "assets/MultiInstance_Logo.svg" ]; then
            ICONSET_DIR="resources/macos/AppIcon.iconset"
            mkdir -p "$ICONSET_DIR"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 16x16 "$ICONSET_DIR/icon_16x16.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 32x32 "$ICONSET_DIR/icon_16x16@2x.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 32x32 "$ICONSET_DIR/icon_32x32.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 64x64 "$ICONSET_DIR/icon_32x32@2x.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 128x128 "$ICONSET_DIR/icon_128x128.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 256x256 "$ICONSET_DIR/icon_128x128@2x.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 256x256 "$ICONSET_DIR/icon_256x256.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 512x512 "$ICONSET_DIR/icon_256x256@2x.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 512x512 "$ICONSET_DIR/icon_512x512.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 1024x1024 "$ICONSET_DIR/icon_512x512@2x.png"
            iconutil -c icns "$ICONSET_DIR" -o "resources/macos/AppIcon.icns"
            rm -rf "$ICONSET_DIR"
          fi

      - name: Build
        run: cargo build --release --target x86_64-apple-darwin

      - name: Get version
        id: get_version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create app bundle and DMG
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          APP_BUNDLE="target/x86_64-apple-darwin/release/MultiInstance.app"

          mkdir -p "$APP_BUNDLE/Contents/MacOS"
          mkdir -p "$APP_BUNDLE/Contents/Resources"
          cp "target/x86_64-apple-darwin/release/multiinstance" "$APP_BUNDLE/Contents/MacOS/"
          cp "resources/macos/Info.plist" "$APP_BUNDLE/Contents/"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" "$APP_BUNDLE/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" "$APP_BUNDLE/Contents/Info.plist"
          if [ -f "resources/macos/AppIcon.icns" ]; then
            cp "resources/macos/AppIcon.icns" "$APP_BUNDLE/Contents/Resources/"
          fi

          codesign --force --deep --sign - "$APP_BUNDLE"
          hdiutil create -volname "MultiInstance" -srcfolder "$APP_BUNDLE" -ov -format UDZO "MultiInstance-$VERSION-macos-intel.dmg"

      - name: Upload macOS Intel artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-release
          path: MultiInstance-*-macos-intel.dmg

  # Build macOS (Apple Silicon)
  build-macos-arm:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-arm-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-arm-cargo-release-

      - name: Install ImageMagick
        run: brew install imagemagick

      - name: Generate macOS icon
        run: |
          # Ensure resources/macos directory exists
          mkdir -p "resources/macos"

          if [ -f "assets/MultiInstance_Logo.svg" ]; then
            ICONSET_DIR="resources/macos/AppIcon.iconset"
            mkdir -p "$ICONSET_DIR"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 16x16 "$ICONSET_DIR/icon_16x16.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 32x32 "$ICONSET_DIR/icon_16x16@2x.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 32x32 "$ICONSET_DIR/icon_32x32.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 64x64 "$ICONSET_DIR/icon_32x32@2x.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 128x128 "$ICONSET_DIR/icon_128x128.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 256x256 "$ICONSET_DIR/icon_128x128@2x.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 256x256 "$ICONSET_DIR/icon_256x256.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 512x512 "$ICONSET_DIR/icon_256x256@2x.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 512x512 "$ICONSET_DIR/icon_512x512.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 1024x1024 "$ICONSET_DIR/icon_512x512@2x.png"
            iconutil -c icns "$ICONSET_DIR" -o "resources/macos/AppIcon.icns"
            rm -rf "$ICONSET_DIR"
          fi

      - name: Build
        run: cargo build --release --target aarch64-apple-darwin

      - name: Get version
        id: get_version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create app bundle and DMG
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          APP_BUNDLE="target/aarch64-apple-darwin/release/MultiInstance.app"

          mkdir -p "$APP_BUNDLE/Contents/MacOS"
          mkdir -p "$APP_BUNDLE/Contents/Resources"
          cp "target/aarch64-apple-darwin/release/multiinstance" "$APP_BUNDLE/Contents/MacOS/"
          cp "resources/macos/Info.plist" "$APP_BUNDLE/Contents/"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" "$APP_BUNDLE/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" "$APP_BUNDLE/Contents/Info.plist"
          if [ -f "resources/macos/AppIcon.icns" ]; then
            cp "resources/macos/AppIcon.icns" "$APP_BUNDLE/Contents/Resources/"
          fi

          codesign --force --deep --sign - "$APP_BUNDLE"
          hdiutil create -volname "MultiInstance" -srcfolder "$APP_BUNDLE" -ov -format UDZO "MultiInstance-$VERSION-macos-apple-silicon.dmg"

      - name: Upload macOS ARM artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm-release
          path: MultiInstance-*-macos-apple-silicon.dmg

  # Build macOS Universal
  build-macos-universal:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin, aarch64-apple-darwin

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-universal-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-universal-cargo-release-

      - name: Install ImageMagick
        run: brew install imagemagick

      - name: Generate macOS icon
        run: |
          # Ensure resources/macos directory exists
          mkdir -p "resources/macos"

          if [ -f "assets/MultiInstance_Logo.svg" ]; then
            ICONSET_DIR="resources/macos/AppIcon.iconset"
            mkdir -p "$ICONSET_DIR"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 16x16 "$ICONSET_DIR/icon_16x16.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 32x32 "$ICONSET_DIR/icon_16x16@2x.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 32x32 "$ICONSET_DIR/icon_32x32.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 64x64 "$ICONSET_DIR/icon_32x32@2x.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 128x128 "$ICONSET_DIR/icon_128x128.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 256x256 "$ICONSET_DIR/icon_128x128@2x.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 256x256 "$ICONSET_DIR/icon_256x256.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 512x512 "$ICONSET_DIR/icon_256x256@2x.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 512x512 "$ICONSET_DIR/icon_512x512.png"
            magick "assets/MultiInstance_Logo.svg" -background none -resize 1024x1024 "$ICONSET_DIR/icon_512x512@2x.png"
            iconutil -c icns "$ICONSET_DIR" -o "resources/macos/AppIcon.icns"
            rm -rf "$ICONSET_DIR"
          fi

      - name: Build both architectures
        run: |
          cargo build --release --target x86_64-apple-darwin
          cargo build --release --target aarch64-apple-darwin

      - name: Get version
        id: get_version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create universal binary and DMG
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          mkdir -p target/universal-apple-darwin/release
          lipo -create \
            target/x86_64-apple-darwin/release/multiinstance \
            target/aarch64-apple-darwin/release/multiinstance \
            -output target/universal-apple-darwin/release/multiinstance

          APP_BUNDLE="target/universal-apple-darwin/release/MultiInstance.app"
          mkdir -p "$APP_BUNDLE/Contents/MacOS"
          mkdir -p "$APP_BUNDLE/Contents/Resources"
          cp "target/universal-apple-darwin/release/multiinstance" "$APP_BUNDLE/Contents/MacOS/"
          cp "resources/macos/Info.plist" "$APP_BUNDLE/Contents/"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" "$APP_BUNDLE/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" "$APP_BUNDLE/Contents/Info.plist"
          if [ -f "resources/macos/AppIcon.icns" ]; then
            cp "resources/macos/AppIcon.icns" "$APP_BUNDLE/Contents/Resources/"
          fi

          codesign --force --deep --sign - "$APP_BUNDLE"
          hdiutil create -volname "MultiInstance" -srcfolder "$APP_BUNDLE" -ov -format UDZO "MultiInstance-$VERSION-macos-universal.dmg"

      - name: Upload macOS Universal artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal-release
          path: MultiInstance-*-macos-universal.dmg

  # Create GitHub Release
  create-release:
    needs: [build-windows, build-macos-intel, build-macos-arm, build-macos-universal]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: MultiInstance v${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: |
            artifacts/windows-release/*
            artifacts/macos-intel-release/*
            artifacts/macos-arm-release/*
            artifacts/macos-universal-release/*
          body: |
            ## MultiInstance v${{ steps.get_version.outputs.VERSION }}

            ### Downloads

            **Windows:**
            - `MultiInstance-${{ steps.get_version.outputs.VERSION }}-windows-x64.zip` - Portable version
            - `MultiInstance-${{ steps.get_version.outputs.VERSION }}-windows-x64-setup.exe` - Installer

            **macOS:**
            - `MultiInstance-${{ steps.get_version.outputs.VERSION }}-macos-universal.dmg` - Universal (Intel + Apple Silicon) - **Recommended**
            - `MultiInstance-${{ steps.get_version.outputs.VERSION }}-macos-intel.dmg` - Intel only
            - `MultiInstance-${{ steps.get_version.outputs.VERSION }}-macos-apple-silicon.dmg` - Apple Silicon only

            ### Installation

            **Windows:**
            - Run the installer or extract the ZIP to any location

            **macOS:**
            - Open the DMG file
            - Drag MultiInstance to your Applications folder
            - On first run, right-click and select "Open" to bypass Gatekeeper

            ---
            *See the [README](https://github.com/${{ github.repository }}/blob/main/README.md) for more information.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
